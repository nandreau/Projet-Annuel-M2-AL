import{a as ce}from"./chunk-XDNR7TPJ.js";import{a as me}from"./chunk-X5X5ECOX.js";import{B as se,D as le,a as te,b as ne,c as ie,d as re,g as oe,q as ae}from"./chunk-BGEFYTHM.js";import{a as z,f as $}from"./chunk-AVJKP4BS.js";import{Ib as ee,J as Y,W as Z}from"./chunk-JUQHIW5V.js";import{B as R,E as U,F as G,G as J,H as K,I as Q,M as X,j,l as q,m as D,q as k}from"./chunk-DCZ4DVFQ.js";import"./chunk-F2X3VGZZ.js";import{$b as H,Ab as a,Bb as r,Cb as E,Db as S,Eb as I,Gb as N,Lb as h,Mb as g,Pb as B,Ra as o,Wa as W,Xb as l,Yb as P,Zb as x,_b as O,ac as C,bc as v,cc as y,db as A,ea as _,ec as L,fa as u,fc as T,jb as b,oc as M,q as V,qc as w,rb as m}from"./chunk-SDAJZUUB.js";import"./chunk-K52QYQVA.js";import"./chunk-7KGURMOZ.js";import"./chunk-I4GAAI6Y.js";import"./chunk-T6YKWIIR.js";import"./chunk-VBESZKOS.js";import"./chunk-4BZVYRZJ.js";import"./chunk-BNWIWOXL.js";import"./chunk-4U6PRYVA.js";import"./chunk-DLZWFDKZ.js";import"./chunk-JWIEPCRG.js";import"./chunk-C5RQ2IC2.js";import"./chunk-D4VGNZLR.js";import"./chunk-JHLW7V75.js";import"./chunk-SV7S5NYR.js";import{k as F}from"./chunk-OWF7QSRQ.js";var de=()=>[],pe=s=>({"align-items-end":s});function ge(s,c){if(s&1&&(S(0),a(1,"strong"),l(2),r(),l(3," \xB7 "),a(4,"span"),l(5),M(6,"date"),r(),I()),s&2){let e=g().$implicit;o(2),O("",e.user.firstname," ",e.user.name,""),o(3),P(w(6,3,e.createdAt,"d MMMM y HH:mm"))}}function _e(s,c){if(s&1&&(S(0),a(1,"span"),l(2),M(3,"date"),r(),l(4," \xB7 "),a(5,"strong"),l(6),r(),I()),s&2){let e=g().$implicit;o(2),P(w(3,3,e.createdAt,"d MMMM y HH:mm")),o(4),O("",e.user.firstname," ",e.user.name,"")}}function ue(s,c){if(s&1&&(a(0,"div",36),l(1),r()),s&2){let e=c.$implicit;o(),x(" ",e," ")}}function be(s,c){if(s&1&&(a(0,"div",31)(1,"div",32),b(2,ge,7,6,"ng-container",33)(3,_e,7,6,"ng-container",33),r(),a(4,"div",34),b(5,ue,2,1,"div",35),r()()),s&2){let e=c.$implicit;m("ngClass",T(5,pe,e.side==="right")),o(2),m("ngIf",e.side==="left"),o(),m("ngIf",e.side==="right"),o(),m("ngClass",T(7,pe,e.side==="right")),o(),m("ngForOf",e.contents)}}function fe(s,c){if(s&1&&(a(0,"div",28)(1,"div",29),l(2," Historique des messages "),r(),b(3,be,6,9,"div",30),r()),s&2){let e=g().$implicit,n=g();o(3),m("ngForOf",n.groupMessages(e.problem_messages))}}function he(s,c){if(s&1){let e=N();a(0,"p-accordion-panel",8)(1,"p-accordion-header")(2,"div",9)(3,"div",10)(4,"div",11),l(5),r(),a(6,"div",12)(7,"span")(8,"b"),l(9,"Chantier:"),r(),l(10),r(),a(11,"span")(12,"b"),l(13,"Phase:"),r(),l(14),r(),a(15,"span")(16,"b"),l(17,"T\xE2che:"),r(),l(18),r(),a(19,"span")(20,"b"),l(21,"Signal\xE9 le"),r(),l(22),M(23,"date"),r()()(),E(24,"p-tag",13),r()(),a(25,"p-accordion-content")(26,"div",14)(27,"div",15)(28,"div",16)(29,"label",17),l(30,"Urgence :"),r(),a(31,"p-select",18),y("ngModelChange",function(i){let t=_(e).$implicit;return v(t.priority,i)||(t.priority=i),u(i)}),h("onChange",function(){let i=_(e).$implicit,t=g();return u(t.updateMeta(i))}),r()(),a(32,"div",19)(33,"label",17),l(34,"Statut :"),r(),a(35,"p-select",18),y("ngModelChange",function(i){let t=_(e).$implicit;return v(t.status,i)||(t.status=i),u(i)}),h("onChange",function(){let i=_(e).$implicit,t=g();return u(t.updateMeta(i))}),r()()(),a(36,"div",20)(37,"app-image-manager",21),h("imagesChange",function(i){let t=_(e).$implicit,p=g();return u(p.onImagesChange(t,i))}),r()(),a(38,"label",17),l(39,"Description"),r(),a(40,"div",22),l(41),r(),b(42,fe,4,1,"div",23),a(43,"form",24),h("ngSubmit",function(){let i=_(e).$implicit,t=g();return u(t.sendMessage(i))}),a(44,"textarea",25),y("ngModelChange",function(i){let t=_(e).$implicit,p=g();return v(p.newComments[t.id],i)||(p.newComments[t.id]=i),u(i)}),r(),a(45,"div",26)(46,"p-button",27),l(47," Commenter"),r()()()()()()}if(s&2){let e=c.$implicit,n=g();m("value",e.id),o(5),H(" ",e.id," \u2014 ",e.title," (",e.priority,") "),o(5),x(" ",e.chantier.title||"\u2014",""),o(4),x(" ",e.phaseLabel,""),o(4),x(" ",e.taskLabel,""),o(4),x(" ",w(23,20,e.createdAt,"d MMMM y HH:mm"),""),o(2),m("value",e.status)("severity",e.status==="En cours"?"warn":e.status==="Non r\xE9solu"?"danger":"success"),o(7),m("options",n.priorityOptions),C("ngModel",e.priority),o(4),m("options",n.statusOptions),C("ngModel",e.status),o(2),m("images",e.images||L(23,de)),o(4),P(e.description),o(),m("ngIf",e.problem_messages.length),o(2),B("name","comment-",e.id,""),C("ngModel",n.newComments[e.id])}}function xe(s,c){s&1&&(a(0,"div",37),l(1," Aucun probl\xE8me en cours "),r())}var He=(()=>{let c=class c{constructor(n){this.request=n,this.problems=[],this.filteredProblems=[],this.chantierOptions=[],this.selectedChantier=null,this.priorityOptions=[{label:"Urgent",value:"Urgent"},{label:"Important",value:"Important"},{label:"Moyen",value:"Moyen"},{label:"Faible",value:"Faible"}],this.statusOptions=[{label:"En cours",value:"En cours"},{label:"Non r\xE9solu",value:"Non r\xE9solu"},{label:"R\xE9solu",value:"R\xE9solu"}],this.newComments={},this.activeProblem=0,z({camera:$})}ngOnInit(){this.loadProblems()}loadProblems(){this.request.get("api/problems",!1).subscribe({next:n=>{this.problems=n,this.filteredProblems=[...n];let i=new Map;n.forEach(t=>{t.chantier&&i.set(t.chantier.id,t.chantier.title)}),this.chantierOptions=[{label:"Tous les chantiers",value:null},...Array.from(i.entries()).map(([t,p])=>({label:p,value:t}))]},error:n=>console.error("Erreur chargement probl\xE8mes",n)})}onChantierChange(){this.selectedChantier!=null?this.filteredProblems=this.problems.filter(n=>{var i;return((i=n.chantier)==null?void 0:i.id)===this.selectedChantier}):this.filteredProblems=[...this.problems]}sendMessage(n){return F(this,null,function*(){var p;let i=(p=this.newComments[n.id])==null?void 0:p.trim();if(!i)return;let t={problemId:n.id,content:i};try{let d=yield V(this.request.post("api/problemMessages",t,!0));n.problem_messages=n.problem_messages||[],n.problem_messages.push(d.data),this.newComments[n.id]=""}catch(d){console.error("\xC9chec envoi message",d)}})}updateMeta(n){let i={priority:n.priority,status:n.status,images:n.images};this.request.put(`api/problems/${n.id}/meta`,i,!0).subscribe({next:()=>console.log("Probl\xE8me mis \xE0 jour"),error:t=>console.error("\xC9chec mise \xE0 jour",t)})}onImagesChange(n,i){n.images=i,this.updateMeta(n)}groupMessages(n){let i=[],t=null,p=null,d="right";for(let f of n)f.user.id!==p?(d=d==="left"?"right":"left",t={user:f.user,createdAt:f.createdAt,side:d,contents:[f.content]},i.push(t),p=f.user.id):t&&t.contents.push(f.content);return i}};c.\u0275fac=function(i){return new(i||c)(W(ee))},c.\u0275cmp=A({type:c,selectors:[["app-problems"]],decls:10,vars:7,consts:[[3,"fullscreen"],[1,"container"],[1,"header-container"],[1,"header-container-title"],["optionLabel","label","optionValue","value","placeholder","Filtrer par chantiers","filter","",1,"ml-4",3,"ngModelChange","onChange","options","ngModel"],[3,"activeIndexChange","activeIndex","multiple"],["class","mb-3",3,"value",4,"ngFor","ngForOf"],["class","text-center text-lg font-semibold text-gray-500 absolute-center",4,"ngIf"],[1,"mb-3",3,"value"],[1,"flex","align-items-center","w-full","justify-content-between"],[1,"flex","flex-column"],[1,"flex","bold"],[1,"problem-meta","font-normal","mt-2"],["rounded","true",1,"mr-3",3,"value","severity"],[1,"pt-3"],[1,"flex","justify-content-end"],[1,"flex","align-items-center","gap-2","mr-3"],[1,"font-bold"],["placeholder","Choisir",3,"ngModelChange","onChange","options","ngModel"],[1,"flex","align-items-center","gap-2"],[1,"problem-images","mt-4","mb-3"],[3,"imagesChange","images"],[1,"mt-1","mb-2"],["class","problem-messages mt-4",4,"ngIf"],[1,"problem-comment-box",3,"ngSubmit"],["placeholder","Votre commentaire...","rows","3",3,"ngModelChange","ngModel","name"],[1,"flex","justify-content-end","mt-2"],["type","submit",1,""],[1,"problem-messages","mt-4"],[1,"problem-messages-title","mb-2"],["class","message flex flex-column mb-3",3,"ngClass",4,"ngFor","ngForOf"],[1,"message","flex","flex-column","mb-3",3,"ngClass"],[1,"message-header","mb-1"],[4,"ngIf"],[1,"flex","flex-column","w-full",3,"ngClass"],["class","message-body bg-gray-100 p-2 rounded mb-1",4,"ngFor","ngForOf"],[1,"message-body","bg-gray-100","p-2","rounded","mb-1"],[1,"text-center","text-lg","font-semibold","text-gray-500","absolute-center"]],template:function(i,t){i&1&&(E(0,"app-header"),a(1,"ion-content",0)(2,"div",1)(3,"div",2)(4,"div",3),l(5,"Liste des probl\xE8mes"),r(),a(6,"p-select",4),y("ngModelChange",function(d){return v(t.selectedChantier,d)||(t.selectedChantier=d),d}),h("onChange",function(){return t.onChantierChange()}),r()(),a(7,"p-accordion",5),y("activeIndexChange",function(d){return v(t.activeProblem,d)||(t.activeProblem=d),d}),b(8,he,48,24,"p-accordion-panel",6),r()(),b(9,xe,2,0,"div",7),r()),i&2&&(o(),m("fullscreen",!0),o(5),m("options",t.chantierOptions),C("ngModel",t.selectedChantier),o(),C("activeIndex",t.activeProblem),m("multiple",!1),o(),m("ngForOf",t.filteredProblems),o(),m("ngIf",t.filteredProblems.length===0))},dependencies:[Z,Y,le,re,te,ne,ie,oe,ae,j,q,D,se,k,me,X,Q,R,U,G,K,J,ce],styles:[".problem-container[_ngcontent-%COMP%]{padding:1rem}.problem-meta[_ngcontent-%COMP%]{font-size:.875rem;color:#666;display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.25rem}.problem-messages-title[_ngcontent-%COMP%]{font-weight:600;margin-bottom:.5rem}.problem-messages[_ngcontent-%COMP%]{margin-bottom:1.5rem}.problem-messages[_ngcontent-%COMP%]   .message[_ngcontent-%COMP%]{margin-bottom:1rem}.problem-messages[_ngcontent-%COMP%]   .message.right[_ngcontent-%COMP%]{text-align:right}.problem-messages[_ngcontent-%COMP%]   .message.right[_ngcontent-%COMP%]   .message-body[_ngcontent-%COMP%]{background:#f3f4f6}.problem-messages[_ngcontent-%COMP%]   .message[_ngcontent-%COMP%]   .message-header[_ngcontent-%COMP%]{font-size:.75rem;color:#666}.problem-messages[_ngcontent-%COMP%]   .message[_ngcontent-%COMP%]   .message-body[_ngcontent-%COMP%]{background:#f9fafb;padding:.75rem;border-radius:10px;margin-top:.25rem;display:inline-block;width:max-content;max-width:40%}.problem-comment-box[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid #ccc;border-radius:8px;resize:none;font-size:1rem}"]});let s=c;return s})();export{He as ProblemsPage};
