import{a as se,b as le}from"./chunk-LAXIKTFX.js";import{a as re}from"./chunk-X5X5ECOX.js";import{D as ae,g as ee,j as te,q as ie,r as ne}from"./chunk-BGEFYTHM.js";import{a as Y}from"./chunk-SWGHULUR.js";import"./chunk-AVJKP4BS.js";import{Ib as Z,J as K,L as Q,W as X,i as R,k as U}from"./chunk-JUQHIW5V.js";import{E as H,H as G,M as J,j as q,l as $,m as W,q as z,r as L}from"./chunk-DCZ4DVFQ.js";import"./chunk-F2X3VGZZ.js";import{Ab as r,Bb as s,Cb as v,Db as k,Eb as I,Gb as w,Lb as p,Mb as u,Pb as T,Ra as a,Wa as P,Xb as c,Yb as O,Zb as _,_b as V,ac as E,bc as M,cc as D,db as j,ea as b,fa as x,fc as N,jb as C,oc as y,q as g,qc as S,rb as d,rc as B}from"./chunk-SDAJZUUB.js";import"./chunk-K52QYQVA.js";import"./chunk-7KGURMOZ.js";import"./chunk-I4GAAI6Y.js";import"./chunk-T6YKWIIR.js";import"./chunk-VBESZKOS.js";import"./chunk-4BZVYRZJ.js";import"./chunk-BNWIWOXL.js";import"./chunk-4U6PRYVA.js";import"./chunk-DLZWFDKZ.js";import"./chunk-JWIEPCRG.js";import"./chunk-C5RQ2IC2.js";import"./chunk-D4VGNZLR.js";import"./chunk-JHLW7V75.js";import"./chunk-SV7S5NYR.js";import{a as A,b as F,k as f}from"./chunk-OWF7QSRQ.js";var oe=l=>({"line-through text-gray-500":l});function de(l,m){if(l&1&&(k(0),c(1),y(2,"date"),I()),l&2){let n=u().$implicit;a(),_(" Termin\xE9 le ",S(2,1,n.doneDate,"d MMMM y")," ")}}function ce(l,m){if(l&1&&(k(0),c(1),y(2,"date"),I()),l&2){let n=u().$implicit;a(),_(" \xC0 faire le ",S(2,1,n.dueDate,"d MMMM y")," ")}}function me(l,m){if(l&1){let n=w();r(0,"div",51)(1,"div",52)(2,"p-checkbox",53),D("ngModelChange",function(i){let t=b(n).$implicit;return M(t.done,i)||(t.done=i),x(i)}),s(),r(3,"span",54),c(4),s()(),r(5,"div",55)(6,"div",56),C(7,de,3,4,"ng-container",7)(8,ce,3,4,"ng-container",7),s(),r(9,"p-button",57),p("click",function(){let i=b(n).index,t=u().index,o=u(2);return x(o.openDeleteTask(o.filteredChantierIndex,t,i))}),s()()()}if(l&2){let n=m.$implicit;a(2),E("ngModel",n.done),a(),d("ngClass",N(6,oe,n.done)),a(),_(" ",n.name," "),a(3),d("ngIf",n.done),a(),d("ngIf",!n.done),a(),d("rounded",!0)}}function he(l,m){if(l&1){let n=w();r(0,"div",32)(1,"div",39)(2,"div")(3,"div",40)(4,"div",41),v(5,"i",42),r(6,"span"),c(7),s()(),r(8,"div",43)(9,"p-button",44),p("click",function(){let i=b(n).index,t=u(2);return x(t.openDeletePhase(t.filteredChantierIndex,i))}),s()()(),C(10,me,10,8,"div",45),r(11,"p-button",46),p("click",function(){let i=b(n).index,t=u(2);return x(t.openAddTask(t.filteredChantierIndex,i))}),c(12," + Ajouter une t\xE2che "),s()(),r(13,"div",47)(14,"span",48),c(15,"Avancement"),s(),v(16,"p-progressBar",49),r(17,"span",50),c(18),s()()()()}if(l&2){let n=m.$implicit,e=u(2);a(7),O(n.name),a(2),d("rounded",!0),a(),d("ngForOf",n.tasks),a(6),d("value",e.utils.getPhaseProgress(n))("showValue",!1),a(2),_("",e.utils.getPhaseProgress(n),"%")}}function pe(l,m){if(l&1&&v(0,"ion-img",58),l&2){let n=m.$implicit;d("src",n.avatar)}}function ue(l,m){if(l&1&&(r(0,"div",59),c(1),s()),l&2){let n=u(2);a(),_(" +",n.filteredChantier.intervenants.length-5," ")}}function _e(l,m){if(l&1){let n=w();k(0),r(1,"div",14)(2,"div",15)(3,"div",16),v(4,"ion-img",17),r(5,"div",18)(6,"div",19),c(7),s(),r(8,"div",20)(9,"div"),c(10),s(),r(11,"div",21),c(12),s()()()(),r(13,"div",22)(14,"div",23)(15,"div")(16,"div",20),c(17),y(18,"date"),s(),r(19,"div",24),c(20),y(21,"date"),s()(),r(22,"p-button",25),p("click",function(){b(n);let i=u();return x(i.openDeleteChantier(i.filteredChantierIndex))}),s()(),r(23,"div",26)(24,"span",27),c(25,"Avancement global"),s(),v(26,"p-progressBar",28),r(27,"span",29),c(28),s()()()(),r(29,"div",30),C(30,he,19,6,"div",31),r(31,"div",32)(32,"div",33),p("click",function(){b(n);let i=u();return x(i.openAddPhase(i.filteredChantierIndex))}),v(33,"i",34),s()()(),r(34,"div",35)(35,"div",36),C(36,pe,1,1,"ion-img",37),y(37,"slice"),C(38,ue,2,1,"div",38),s()()(),I()}if(l&2){let n=u();a(4),d("src",n.filteredChantier.images==null?null:n.filteredChantier.images[0]),a(3),_(" ",n.filteredChantier.title," "),a(3),V(" Client : ",n.filteredChantier.client.firstname," ",n.filteredChantier.client.name," "),a(2),_("Adresse : ",n.filteredChantier.address,""),a(5),_(" D\xE9but : ",S(18,14,n.filteredChantier.start,"d MMMM y")," "),a(3),_(" Fin estim\xE9e : ",S(21,17,n.filteredChantier.end,"d MMMM y")," "),a(2),d("rounded",!0),a(4),d("value",n.utils.getChantierProgress(n.filteredChantier))("showValue",!1),a(2),_(" ",n.utils.getChantierProgress(n.filteredChantier),"% "),a(2),d("ngForOf",n.filteredChantier.phases),a(6),d("ngForOf",B(37,20,n.filteredChantier.intervenants,0,5)),a(2),d("ngIf",n.filteredChantier.intervenants.length>5)}}var je=(()=>{let m=class m{constructor(e,i,t,o){this.request=e,this.utils=i,this.route=t,this.router=o,this.chantiers=[],this.chantierOptions=[],this.filteredChantierIndex=0,this.clients=[],this.visibleAddChantier=!1,this.visibleDeleteChantier=!1,this.newChantier={title:"",address:"",start:null,end:null},this.selectedChantierIndex=0,this.visibleAddPhase=!1,this.visibleDeletePhase=!1,this.newPhase={name:""},this.selectedPhaseIndex=0,this.visibleAddTask=!1,this.visibleDeleteTask=!1,this.newTask={name:"",dueDate:null},this.selectedTaskIndex=0,this.selectedChantierName="",this.selectedPhaseName="",this.selectedTaskName="",this.chantierFields=[],this.phaseFields=[],this.taskFields=[]}ngOnInit(){let e=Number(this.route.snapshot.paramMap.get("id"));Promise.all([this.loadClients(),this.loadChantiers()]).then(()=>{if(this.loadFields(),e){let i=this.chantiers.findIndex(t=>t.id===e);i>=0?(this.filteredChantierIndex=i,this.filteredChantier=this.chantiers[i]):this.router.navigate(["/sites"])}}).catch(i=>{console.error("Initialization error",i)})}loadClients(){return f(this,null,function*(){try{let e=yield g(this.request.get("api/users"));this.clients=e.filter(i=>i.roles.some(t=>t.name==="client")).map(i=>F(A({},i),{fullname:`${i.firstname} ${i.name}`}))}catch(e){console.error("Erreur chargement clients",e)}})}loadChantiers(){return f(this,null,function*(){var e;try{this.chantiers=yield g(this.request.get("api/chantiers")),this.chantierOptions=this.chantiers.map(h=>({label:h.title,value:h.id}));let i=this.route.snapshot.paramMap.get("id"),t=i?Number(i):(e=this.chantiers[0])==null?void 0:e.id,o=this.chantiers.find(h=>h.id===t);o?(this.filteredChantier=o,this.selectedChantierIndex=o.id,this.filteredChantierIndex=this.chantiers.indexOf(o)):(this.filteredChantier=this.chantiers[0],this.filteredChantierIndex=0,this.router.navigate(["/sites"]))}catch(i){console.error("Erreur chargement chantiers",i)}})}onChantierChange(){this.filteredChantier=this.chantiers[this.selectedChantierIndex]}loadFields(){this.chantierFields=[{key:"title",label:"Titre",type:"text",placeholder:"Titre du chantier"},{key:"address",label:"Adresse",type:"text",placeholder:"Adresse"},{key:"start",label:"D\xE9but",type:"date",placeholder:""},{key:"end",label:"Fin estim\xE9e",type:"date",placeholder:""},{key:"clientId",label:"Client",type:"select",options:this.clients,optionValue:"id",optionLabel:"fullname",placeholder:"S\xE9lectionner un client"}],this.phaseFields=[{key:"name",label:"Nom de phase",type:"text",placeholder:"Nom de la phase"}],this.taskFields=[{key:"name",label:"Nom",type:"text",placeholder:"Nom de la t\xE2che"},{key:"dueDate",label:"Fin pr\xE9vue",type:"date",placeholder:""}]}openAddChantier(){this.newChantier={title:"",address:"",start:null,end:null},this.visibleAddChantier=!0}handleAddChantier(e){return f(this,null,function*(){try{yield g(this.request.post("api/chantiers",{title:e.title,address:e.address,start:e.start,end:e.end,clientId:e.clientId},!0)),this.visibleAddChantier=!1,yield this.loadChantiers()}catch(i){console.error("Erreur ajout chantier",i)}})}openDeleteChantier(e){this.selectedChantierIndex=e,this.selectedChantierName=this.chantiers[e].title,this.visibleDeleteChantier=!0}confirmDeleteChantier(){return f(this,null,function*(){try{yield g(this.request.delete(`api/chantiers/${this.chantiers[this.selectedChantierIndex].id}`,!0)),this.visibleDeleteChantier=!1,yield this.loadChantiers()}catch(e){console.error("Erreur suppression chantier",e)}})}openAddPhase(e){this.selectedChantierIndex=e,this.newPhase={name:""},this.visibleAddPhase=!0}handleAddPhase(e){return f(this,null,function*(){try{yield g(this.request.post("api/phases",{name:e.name,chantierId:this.chantiers[this.selectedChantierIndex].id},!0)),this.visibleAddPhase=!1,yield this.loadChantiers()}catch(i){console.error("Erreur ajout phase",i)}})}openDeletePhase(e,i){this.selectedChantierIndex=e,this.selectedPhaseIndex=i,this.selectedPhaseName=this.chantiers[e].phases[i].name,this.visibleDeletePhase=!0}confirmDeletePhase(){return f(this,null,function*(){try{let e=this.chantiers[this.selectedChantierIndex].phases[this.selectedPhaseIndex];yield g(this.request.delete(`api/phases/${e.id}`,!0)),this.visibleDeletePhase=!1,yield this.loadChantiers()}catch(e){console.error("Erreur suppression phase",e)}})}openAddTask(e,i){this.selectedChantierIndex=e,this.selectedPhaseIndex=i,this.newTask={name:"",dueDate:null},this.visibleAddTask=!0}handleAddTask(e){return f(this,null,function*(){console.log(e.dueDate,e.name);try{let i={name:e.name,done:!1,dueDate:e.dueDate?e.dueDate.toISOString():null,phaseId:this.chantiers[this.selectedChantierIndex].phases[this.selectedPhaseIndex].id};yield g(this.request.post("api/tasks",i,!0)),this.visibleAddTask=!1,yield this.loadChantiers()}catch(i){console.error("Erreur ajout t\xE2che",i)}})}openDeleteTask(e,i,t){this.selectedChantierIndex=e,this.selectedPhaseIndex=i,this.selectedTaskIndex=t,this.selectedTaskName=this.chantiers[e].phases[i].tasks[t].name,this.visibleDeleteTask=!0}confirmDeleteTask(){return f(this,null,function*(){try{let e=this.chantiers[this.selectedChantierIndex].phases[this.selectedPhaseIndex].tasks[this.selectedTaskIndex];yield g(this.request.delete(`api/tasks/${e.id}`,!0)),this.visibleDeleteTask=!1,yield this.loadChantiers()}catch(e){console.error("Erreur suppression t\xE2che",e)}})}};m.\u0275fac=function(i){return new(i||m)(P(Z),P(Y),P(R),P(U))},m.\u0275cmp=j({type:m,selectors:[["app-sites"]],decls:16,vars:22,consts:[[3,"fullscreen"],[1,"container"],[1,"header-container"],[1,"header-container-title"],[1,"flex","justify-content-end","align-items-center","gap-2"],["label","Nouveau chantier","icon","pi pi-plus",3,"click"],["optionLabel","label","optionValue","value","placeholder","S\xE9lectionner un chantier","filter","","panelStyleClass","w-full",3,"ngModelChange","onChange","options","ngModel"],[4,"ngIf"],["mode","add","header","Ajouter un nouveau chantier","subtitle","Veuillez remplir les informations du chantier.",3,"submitted","closed","visible","model","fields"],["header","Supprimer un chantier","color","danger",3,"submitted","closed","visible","subtitle"],["mode","add","header","Ajouter une phase","subtitle","Saisissez le nom de la phase.",3,"submitted","closed","visible","model","fields"],["header","Supprimer une phase","color","danger",3,"submitted","closed","visible","subtitle"],["mode","add","header","Ajouter une t\xE2che","subtitle","Saisissez les d\xE9tails de la t\xE2che.",3,"submitted","closed","visible","model","fields"],["header","Supprimer une t\xE2che","color","danger",3,"submitted","closed","visible","subtitle"],[1,"form","p-4","mb-4"],[1,"sm:flex","justify-content-between","mb-4","relative"],[1,"flex","items-start"],[1,"image-chantier",3,"src"],[1,"ml-3","mr-6","sm:mr-0","flex","flex-column","justify-content-evenly"],[1,"text-xl","font-semibold","mb-2"],[1,"text-sm","text-gray-600"],[1,"mt-1"],[1,"md:mt-0","mt-3","sm:text-right","flex","flex-column"],[1,"flex","align-items-center","sm:justify-content-end"],[1,"text-sm","text-gray-600","mt-1"],["icon","pi pi-times","variant","text","severity","secondary",1,"ml-2","-mt-1","right-0","top-0","small-absolute",3,"click","rounded"],[1,"flex","align-items-center","mt-1","sm:mt-3","sm:justify-content-end"],[1,"mr-2","text-sm","text-gray-600"],[1,"global-progress-bar",3,"value","showValue"],[1,"ml-2","text-sm","font-semibold"],[1,"grid"],["class","sm:col-6 col-12",4,"ngFor","ngForOf"],[1,"sm:col-6","col-12"],[1,"phase","phase-add",3,"click"],[1,"pi","pi-plus","text-gray-500","text-xl"],[1,"mt-4","flex","align-items-center"],[1,"avatar-stack","flex"],[3,"src",4,"ngFor","ngForOf"],["class","flex align-items-center justify-content-center bg-gray-200 text-xs text-gray-500 font-semibold",4,"ngIf"],[1,"phase","justify-content-between","flex","flex-column"],[1,"flex","justify-content-between","mb-4","align-items-center"],[1,"flex","text-base","font-semibold"],[1,"pi","pi-layer-group"],[1,"flex","items-center","gap-2"],["icon","pi pi-times","variant","text","severity","secondary",1,"p-button-sm","p-0",3,"click","rounded"],["class","flex justify-content-between align-items-center mb-1",4,"ngFor","ngForOf"],["variant","text",3,"click"],[1,"mt-3","flex","gap-2","align-items-center","justify-content-end"],[1,"mr-0","text-sm","text-gray-600"],[1,"phase-progress-bar",3,"value","showValue"],[1,"text-sm","font-medium"],[1,"flex","justify-content-between","align-items-center","mb-1"],[1,"flex","items-center"],["binary","true","readonly","",1,"p-checkbox-sm",3,"ngModelChange","ngModel"],[1,"ml-2","text-sm",3,"ngClass"],[1,"flex","align-items-center"],[1,"text-right","text-xs","ml-2","text-gray-500"],["icon","pi pi-times","variant","text","severity","secondary",1,"small-icon-btn","ml-2",3,"click","rounded"],[3,"src"],[1,"flex","align-items-center","justify-content-center","bg-gray-200","text-xs","text-gray-500","font-semibold"]],template:function(i,t){i&1&&(v(0,"app-header"),r(1,"ion-content",0)(2,"div",1)(3,"div",2)(4,"div",3),c(5,"Liste des chantiers"),s(),r(6,"div",4)(7,"p-button",5),p("click",function(){return t.openAddChantier()}),s(),r(8,"p-select",6),D("ngModelChange",function(h){return M(t.selectedChantierIndex,h)||(t.selectedChantierIndex=h),h}),p("onChange",function(){return t.onChantierChange()}),s()()(),C(9,_e,39,24,"ng-container",7),s(),r(10,"app-dynamic-form-modal",8),p("submitted",function(h){return t.handleAddChantier(h)})("closed",function(){return t.visibleAddChantier=!1}),s(),r(11,"app-confirm-modal",9),p("submitted",function(){return t.confirmDeleteChantier()})("closed",function(){return t.visibleDeleteChantier=!1}),s(),r(12,"app-dynamic-form-modal",10),p("submitted",function(h){return t.handleAddPhase(h)})("closed",function(){return t.visibleAddPhase=!1}),s(),r(13,"app-confirm-modal",11),p("submitted",function(){return t.confirmDeletePhase()})("closed",function(){return t.visibleDeletePhase=!1}),s(),r(14,"app-dynamic-form-modal",12),p("submitted",function(h){return t.handleAddTask(h)})("closed",function(){return t.visibleAddTask=!1}),s(),r(15,"app-confirm-modal",13),p("submitted",function(){return t.confirmDeleteTask()})("closed",function(){return t.visibleDeleteTask=!1}),s()()),i&2&&(a(),d("fullscreen",!0),a(7),d("options",t.chantierOptions),E("ngModel",t.selectedChantierIndex),a(),d("ngIf",t.filteredChantier),a(),d("visible",t.visibleAddChantier)("model",t.newChantier)("fields",t.chantierFields),a(),T("subtitle","Voulez-vous vraiment supprimer le chantier \xAB ",t.selectedChantierName," \xBB ? "),d("visible",t.visibleDeleteChantier),a(),d("visible",t.visibleAddPhase)("model",t.newPhase)("fields",t.phaseFields),a(),T("subtitle","Supprimer la phase \xAB ",t.selectedPhaseName," \xBB ? "),d("visible",t.visibleDeletePhase),a(),d("visible",t.visibleAddTask)("model",t.newTask)("fields",t.taskFields),a(),T("subtitle","Supprimer la t\xE2che \xAB ",t.selectedTaskName,"  \xBB ?"),d("visible",t.visibleDeleteTask))},dependencies:[X,K,Q,ae,ee,te,ie,q,$,W,ne,L,z,re,J,H,G,se,le],styles:[".global-progress-bar[_ngcontent-%COMP%]{min-width:120px;width:10vw;max-width:150px}.phase-progress-bar[_ngcontent-%COMP%]{min-width:70px;width:7vw;max-width:100px}  .global-progress-bar .p-progressbar{height:14px!important}.phase[_ngcontent-%COMP%]{margin:0;height:100%;background-color:var(--background-color);padding:1rem;border:1px solid var(--border-color);border-radius:.25rem;position:relative}.image-chantier[_ngcontent-%COMP%]{height:6rem;max-width:10rem}.image-chantier[_ngcontent-%COMP%]::part(image){border-radius:.25rem}.phase-add[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;cursor:pointer;transition:background-color .2s}.phase-add[_ngcontent-%COMP%]:hover{background-color:#e9ebef}.avatar-stack[_ngcontent-%COMP%]   ion-img[_ngcontent-%COMP%]::part(image), .avatar-stack[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{margin-right:-1rem;width:2rem;height:2rem;border-radius:50%;display:inline-block}"]});let l=m;return l})();export{je as SitesPage};
