import{a as ae,b as oe}from"./chunk-LAXIKTFX.js";import{a as ie}from"./chunk-X5X5ECOX.js";import{D as ne,g as Z,q as ee,r as te}from"./chunk-BGEFYTHM.js";import{a as Q}from"./chunk-SWGHULUR.js";import"./chunk-AVJKP4BS.js";import{Ib as X,J,W as K}from"./chunk-JUQHIW5V.js";import{E as R,H as U,M as Y,j,l as q,m as B,p as L}from"./chunk-DCZ4DVFQ.js";import"./chunk-F2X3VGZZ.js";import{Ab as l,Bb as c,Cb as C,Db as k,Eb as w,Gb as W,Lb as f,Mb as _,Ra as o,Wa as $,Xb as u,Yb as y,Zb as A,ac as S,bc as F,cc as E,db as z,ea as x,fa as D,fc as G,jb as h,oc as N,pc as H,q as b,rb as m}from"./chunk-SDAJZUUB.js";import"./chunk-K52QYQVA.js";import"./chunk-7KGURMOZ.js";import"./chunk-I4GAAI6Y.js";import"./chunk-T6YKWIIR.js";import"./chunk-VBESZKOS.js";import"./chunk-4BZVYRZJ.js";import"./chunk-BNWIWOXL.js";import"./chunk-4U6PRYVA.js";import"./chunk-DLZWFDKZ.js";import"./chunk-JWIEPCRG.js";import"./chunk-C5RQ2IC2.js";import"./chunk-D4VGNZLR.js";import"./chunk-JHLW7V75.js";import"./chunk-SV7S5NYR.js";import{a as I,b as V,k as P}from"./chunk-OWF7QSRQ.js";var re=i=>({"today-cell":i});function se(i,d){if(i&1&&(l(0,"div",27)(1,"div",28),u(2),c(),l(3,"div",29),u(4),N(5,"titlecase"),c(),l(6,"div",30),u(7),c()()),i&2){let r=d.$implicit,e=_(3);m("ngClass",G(6,re,e.isToday(r.date))),o(2),y(r.shortName),o(2),y(H(5,4,r.name)),o(3),y(r.day)}}function le(i,d){i&1&&C(0,"i",38)}function ce(i,d){i&1&&C(0,"i",39)}function de(i,d){i&1&&C(0,"i",40)}function me(i,d){i&1&&C(0,"i",41)}function pe(i,d){if(i&1){let r=W();k(0),l(1,"div",43),f("click",function(n){let t=x(r).$implicit,a=_(5);return n.stopPropagation(),D(a.openEditModal(t))}),l(2,"span",44),u(3),c(),l(4,"i",45),f("click",function(n){let t=x(r).$implicit,a=_(5);return n.stopPropagation(),D(a.openDeleteModal(t))}),c()(),w()}if(i&2){let r=d.$implicit;o(3),y(r.time)}}function ge(i,d){if(i&1){let r=W();k(0),l(1,"div",42),f("click",function(){let n=x(r).$implicit,t=_().$implicit,a=_(3);return D(a.openAddModal(t.id,n.date))}),h(2,pe,5,1,"ng-container",14),c(),w()}if(i&2){let r=d.$implicit,e=_().$implicit,n=_(3);o(2),m("ngForOf",n.getSchedulesForDay(e,r.date))}}function _e(i,d){if(i&1&&(l(0,"div",31)(1,"div",32),h(2,le,1,0,"i",33)(3,ce,1,0,"i",34)(4,de,1,0,"i",35)(5,me,1,0,"i",36),l(6,"span",37),u(7),c()(),h(8,ge,3,1,"ng-container",14),c()),i&2){let r=d.$implicit,e=_(3);o(2),m("ngIf",e.utils.getTaskState(r)==="Termin\xE9e"),o(),m("ngIf",e.utils.getTaskState(r)==="En retard"),o(),m("ngIf",e.utils.getTaskState(r)==="En cours"),o(),m("ngIf",e.utils.getTaskState(r)==="\xC0 faire"),o(2),y(r.name),o(),m("ngForOf",e.days)}}function ue(i,d){if(i&1&&(k(0),l(1,"div",15)(2,"div",16)(3,"span",17),u(4),c(),l(5,"span",18),u(6),c()(),l(7,"div",19),C(8,"p-progressBar",20),l(9,"span",21),u(10),c()()(),l(11,"div",22)(12,"div",23)(13,"div",24),u(14,"Chantier / T\xE2che"),c(),h(15,se,8,8,"div",25),c(),h(16,_e,9,6,"div",26),c(),w()),i&2){let r=d.$implicit,e=_(2);o(4),y(r.name),o(2),A("(",r.tasks.length," t\xE2ches)"),o(2),m("value",e.utils.getPhaseProgress(r))("showValue",!1),o(2),A("",e.utils.getPhaseProgress(r),"% "),o(5),m("ngForOf",e.days),o(),m("ngForOf",e.getVisibleTasks(r))}}function fe(i,d){if(i&1&&(k(0),h(1,ue,17,7,"ng-container",14),w()),i&2){let r=_();o(),m("ngForOf",r.getVisiblePhases())}}var Ie=(()=>{let d=class d{constructor(e,n){this.request=e,this.utils=n,this.days=[],this.chantiers=[],this.artisans=[],this.groupOptions=[],this.selectedGroup=null,this.taskOptions=[],this.selectedTask=null,this.weekRange="",this.today=new Date,this.assignmentFormVisible=!1,this.confirmVisible=!1,this.formMode="add",this.formTitle="",this.formFields=[],this.formModel={}}ngOnInit(){return P(this,null,function*(){yield this.loadArtisans(),this.initWeekDays(),yield this.loadChantiers(),this.updateGroupOptions(),this.updateTaskOptions()})}initWeekDays(){let n=(this.today.getDay()+6)%7,t=new Date(this.today);t.setDate(this.today.getDate()-n);let a=new Intl.DateTimeFormat("fr-FR",{weekday:"long"}),s=new Intl.DateTimeFormat("fr-FR",{day:"2-digit"}),p=new Intl.DateTimeFormat("fr-FR",{month:"long"});this.days=[];for(let v=0;v<7;v++){let M=new Date(t);M.setDate(t.getDate()+v),this.days.push({date:M,name:a.format(M),day:s.format(M),shortName:a.format(M).charAt(0).toUpperCase()})}let g=s.format(this.days[0].date),O=s.format(this.days[6].date),T=p.format(this.days[0].date);this.weekRange=`${g} \u2013 ${O} ${T} ${this.days[0].date.getFullYear()}`}loadChantiers(){return P(this,null,function*(){try{this.chantiers=yield b(this.request.get("api/chantiers")),this.selectedChantier=this.chantiers[0]}catch(e){console.error("Erreur chargement chantiers",e)}})}loadArtisans(){return P(this,null,function*(){try{let e=yield b(this.request.get("api/users"));this.artisans=e.filter(n=>n.roles.some(t=>t.name==="artisan")).map(n=>V(I({},n),{fullname:`${n.firstname} ${n.name}`}))}catch(e){console.error("Erreur chargement artisans",e)}})}onChantierChange(){this.updateGroupOptions(),this.updateTaskOptions()}updateGroupOptions(){let n=this.selectedChantier.intervenants||[];this.groupOptions=[{id:null,name:"Tous les artisans"},...n.map(t=>({id:t.id,name:`${t.firstname} ${t.name}`}))],this.selectedGroup=null}getSchedulesForDay(e,n){let t=e.assignments;this.selectedGroup!==null&&(t=t.filter(p=>p.users.some(g=>g.id===this.selectedGroup)));let a=new Date(n);a.setHours(0,0,0,0);let s=new Date(n);return s.setHours(23,59,59,999),t.filter(p=>p.startDate&&p.endDate).filter(p=>new Date(p.startDate)<=s&&new Date(p.endDate)>=a).map(p=>{let g=v=>v.toString().padStart(2,"0"),O=new Date(p.startDate),T=new Date(p.endDate);return V(I({},p),{time:`${g(O.getHours())}h${g(O.getMinutes())} \u2013 ${g(T.getHours())}h${g(T.getMinutes())}`})})}updateTaskOptions(){if(!this.selectedChantier){this.taskOptions=[],this.selectedTask=null;return}let e=this.selectedChantier.phases.reduce((n,t)=>n.concat(t.tasks),[]);this.taskOptions=e.map(n=>({id:n.id,name:n.name})),this.taskOptions.unshift({id:null,name:"Toutes les t\xE2ches"}),this.selectedTask=null}getVisiblePhases(){return this.selectedChantier?this.selectedChantier.phases.filter(e=>this.getVisibleTasks(e).length>0):[]}getVisibleTasks(e){return this.selectedTask?e.tasks.filter(n=>n.id===this.selectedTask):e.tasks}isToday(e){let n=new Date;return e.getDate()===n.getDate()&&e.getMonth()===n.getMonth()&&e.getFullYear()===n.getFullYear()}prev(){this.today.setDate(this.today.getDate()-7),this.initWeekDays()}next(){this.today.setDate(this.today.getDate()+7),this.initWeekDays()}navigateToday(){this.today=new Date,this.initWeekDays()}openAddModal(e,n){this.formMode="add",this.formTitle="Ajouter une nouvelle assignation",this.formModel={taskId:e,date:n,startTime:"08:00",endTime:"17:00",users:[]},this.defineFormFields(),this.assignmentFormVisible=!0}openEditModal(e){this.formMode="edit";let n=new Date(e.startDate),t=new Date(e.endDate),a=s=>s.toString().padStart(2,"0");this.formTitle="Modifier une assignation",this.formModel={id:e.id,taskId:e.taskId,date:n,startTime:`${a(n.getHours())}:${a(n.getMinutes())}`,endTime:`${a(t.getHours())}:${a(t.getMinutes())}`,users:e.users.map(s=>s.id)},this.defineFormFields(),this.assignmentFormVisible=!0}defineFormFields(){this.formFields=[{key:"date",label:"Date",type:"date",placeholder:""},{key:"startTime",label:"D\xE9but",type:"time",placeholder:""},{key:"endTime",label:"Fin",type:"time",placeholder:""},{key:"users",label:"Artisans",type:"multiselect",options:this.artisans,optionLabel:"fullname",optionValue:"id",placeholder:"S\xE9lectionner"}]}onFormSubmit(e){return P(this,null,function*(){let[n,t]=e.startTime.split(":").map(Number),[a,s]=e.endTime.split(":").map(Number),p=new Date(e.date);p.setHours(n,t,0,0);let g=new Date(e.date);g.setHours(a,s,0,0),this.formMode==="add"?yield b(this.request.post("api/assignments",{taskId:e.taskId,startDate:p,endDate:g,assignment_users:e.users},!0)):yield b(this.request.put(`api/assignments/${e.id}`,{startDate:p,endDate:g,assignment_users:e.users},!0)),this.assignmentFormVisible=!1,yield this.loadChantiers()})}openDeleteModal(e){this.deleteAssignmentId=e.id,this.confirmVisible=!0}onDeleteConfirm(){return P(this,null,function*(){this.deleteAssignmentId&&(yield b(this.request.delete(`api/assignments/${this.deleteAssignmentId}`,!0)),this.confirmVisible=!1,yield this.loadChantiers())})}};d.\u0275fac=function(n){return new(n||d)($(X),$(Q))},d.\u0275cmp=z({type:d,selectors:[["app-planning"]],decls:16,vars:17,consts:[[3,"fullscreen"],[1,"container"],[1,"planning-filter"],["optionLabel","title","filter","","placeholder","Chantier","panelStyleClass","w-full",3,"ngModelChange","onChange","options","ngModel"],["optionLabel","name","optionValue","id","filter","","placeholder","Artisan","panelStyleClass","w-full",3,"ngModelChange","options","ngModel"],["optionLabel","name","optionValue","id","filter","","placeholder","T\xE2che","panelStyleClass","w-full",3,"ngModelChange","options","ngModel"],[1,"flex","gap-2","align-items-center","mb-2"],["severity","contrast","variant","text","icon","pi pi-chevron-left",3,"click","rounded"],[1,"font-medium"],["severity","contrast","variant","text","icon","pi pi-chevron-right",3,"click","rounded"],["severity","contrast","variant","text","label","Aujourd'hui",1,"ml-2",3,"click"],[4,"ngIf"],[3,"submitted","closed","visible","mode","fields","model","subtitle"],["header","Supprimer assignation","subtitle","Confirmer la suppression?","color","danger",3,"submitted","closed","visible"],[4,"ngFor","ngForOf"],[1,"planning-chantier"],[1,"flex","align-items-center","items-center","gap-2"],[1,"font-semibold"],[1,"text-sm","text-gray-600"],[1,"w-3","flex","align-items-center"],[1,"w-full",3,"value","showValue"],[1,"text-sm","ml-2"],[1,"phase-scroll-container"],[1,"planning-grid","planning-header"],[1,"planning-header-cell","sticky-col"],["class","planning-header-cell",3,"ngClass",4,"ngFor","ngForOf"],["class","planning-grid planning-task-row",4,"ngFor","ngForOf"],[1,"planning-header-cell",3,"ngClass"],[1,"day-name-short"],[1,"day-name-full"],[1,"day-number"],[1,"planning-grid","planning-task-row"],[1,"planning-task-cell"],["class","pi pi-check-circle icon-done",4,"ngIf"],["class","pi pi-exclamation-circle icon-overdue",4,"ngIf"],["class","pi pi-clock icon-ongoing",4,"ngIf"],["class","pi pi-hourglass icon-todo",4,"ngIf"],[1,"task-name"],[1,"pi","pi-check-circle","icon-done"],[1,"pi","pi-exclamation-circle","icon-overdue"],[1,"pi","pi-clock","icon-ongoing"],[1,"pi","pi-hourglass","icon-todo"],[1,"planning-task-cell",3,"click"],[1,"assignment-block",3,"click"],[1,"assignment-time"],[1,"assignment-icon","pi","pi-times",3,"click"]],template:function(n,t){n&1&&(C(0,"app-header"),l(1,"ion-content",0)(2,"div",1)(3,"div",2)(4,"p-select",3),E("ngModelChange",function(s){return F(t.selectedChantier,s)||(t.selectedChantier=s),s}),f("onChange",function(){return t.onChantierChange()}),c(),l(5,"p-select",4),E("ngModelChange",function(s){return F(t.selectedGroup,s)||(t.selectedGroup=s),s}),c(),l(6,"p-select",5),E("ngModelChange",function(s){return F(t.selectedTask,s)||(t.selectedTask=s),s}),c()(),l(7,"div",6)(8,"p-button",7),f("click",function(){return t.prev()}),c(),l(9,"span",8),u(10),c(),l(11,"p-button",9),f("click",function(){return t.next()}),c(),l(12,"p-button",10),f("click",function(){return t.navigateToday()}),c()(),h(13,fe,2,1,"ng-container",11),l(14,"app-dynamic-form-modal",12),f("submitted",function(s){return t.onFormSubmit(s)})("closed",function(){return t.assignmentFormVisible=!1}),c(),l(15,"app-confirm-modal",13),f("submitted",function(){return t.onDeleteConfirm()})("closed",function(){return t.confirmVisible=!1}),c()()()),n&2&&(o(),m("fullscreen",!0),o(3),m("options",t.chantiers),S("ngModel",t.selectedChantier),o(),m("options",t.groupOptions),S("ngModel",t.selectedGroup),o(),m("options",t.taskOptions),S("ngModel",t.selectedTask),o(2),m("rounded",!0),o(2),y(t.weekRange),o(),m("rounded",!0),o(2),m("ngIf",t.selectedChantier),o(),m("visible",t.assignmentFormVisible)("mode",t.formMode)("fields",t.formFields)("model",t.formModel)("subtitle",t.formTitle),o(),m("visible",t.confirmVisible))},dependencies:[K,J,ne,Z,ee,j,q,B,te,L,ie,Y,R,U,ae,oe],styles:['.container[_ngcontent-%COMP%]{padding:1rem;max-width:100%;margin:0 auto}.planning-filter[_ngcontent-%COMP%]{display:flex;gap:1rem;margin-bottom:1rem}.planning-nav[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}.week-range[_ngcontent-%COMP%]{font-weight:500}.today-btn[_ngcontent-%COMP%]{margin-left:auto}.phase-scroll-container[_ngcontent-%COMP%]{overflow-x:auto}.planning-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:minmax(150px,20%) repeat(7,minmax(75px,1fr))}.planning-header-cell[_ngcontent-%COMP%]{padding:.75rem .5rem;text-align:center;border-right:1px solid var(--border-color);border-bottom:1px solid var(--border-color)}.planning-header-cell[_ngcontent-%COMP%]:first-child{border-left:1px solid var(--border-color)}.day-name-short[_ngcontent-%COMP%]{display:none;font-size:.875rem;color:#6b7280}.day-name-full[_ngcontent-%COMP%]{display:block;font-size:1rem;color:#6b7280}.day-number[_ngcontent-%COMP%]{font-size:1.25rem;color:#374151}.planning-chantier[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.5rem 1rem;background:#f7fafc;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color)}.phase-name[_ngcontent-%COMP%]{font-weight:600}.phase-count[_ngcontent-%COMP%]{font-size:.875rem;color:#4b5563}.phase-progress[_ngcontent-%COMP%]{flex:1}.phase-percent[_ngcontent-%COMP%]{margin-left:.5rem;font-size:.875rem}.planning-task-row[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{border-right:1px solid var(--border-color);border-bottom:1px solid var(--border-color)}.planning-task-row[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]:first-child{border-left:1px solid var(--border-color)}.planning-task-cell[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;padding:.5rem 1rem;cursor:pointer}.icon-done[_ngcontent-%COMP%]{color:#10b981}.icon-overdue[_ngcontent-%COMP%]{color:#ef4444}.icon-ongoing[_ngcontent-%COMP%]{color:#f59e0b}.icon-todo[_ngcontent-%COMP%]{color:#9ca3af}.task-name[_ngcontent-%COMP%]{margin-left:.5rem}.assignment-block[_ngcontent-%COMP%]{display:flex;justify-content:space-between;background-color:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;padding:.2rem .4rem;margin:.2rem}.assignment-time[_ngcontent-%COMP%]{font-size:.875rem;color:#374151}.assignment-icon[_ngcontent-%COMP%]{font-size:.75rem;color:#6b7280;margin-left:.375rem}.today-cell[_ngcontent-%COMP%]{position:relative}.today-cell[_ngcontent-%COMP%]   .day-name-short[_ngcontent-%COMP%], .today-cell[_ngcontent-%COMP%]   .day-name-full[_ngcontent-%COMP%]{color:var(--color-primary)}.today-cell[_ngcontent-%COMP%]   .day-number[_ngcontent-%COMP%]{font-weight:700;color:var(--color-primary)}.today-cell[_ngcontent-%COMP%]:after{content:"";position:absolute;bottom:6px;left:50%;transform:translate(-50%);width:6px;height:6px;background:var(--color-primary);border-radius:50%}@media screen and (max-width: 768px){.day-name-short[_ngcontent-%COMP%]{display:block}.day-name-full[_ngcontent-%COMP%]{display:none}.day-number[_ngcontent-%COMP%]{font-size:1rem}.planning-header-cell[_ngcontent-%COMP%]{padding:.5rem .25rem}.planning-task-cell[_ngcontent-%COMP%]{padding:.25rem .5rem}.assignment-block[_ngcontent-%COMP%]{padding:.25rem}.assignment-time[_ngcontent-%COMP%]{font-size:.75rem}.assignment-icon[_ngcontent-%COMP%]{font-size:.75rem;margin-left:.25rem}.today-cell[_ngcontent-%COMP%]:after{display:none}}']});let i=d;return i})();export{Ie as PlanningPage};
